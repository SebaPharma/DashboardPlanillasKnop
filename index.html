<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📊 Dashboard Planillas Knop</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f9;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      color: #1a5276;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
    }
    header p {
      margin: 5px 0 0;
      color: #555;
      font-size: 16px;
    }
    .last-update {
      font-size: 14px;
      color: #777;
      text-align: center;
      margin-bottom: 20px;
    }

    /* Contadores */
    .counters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #555;
    }
    .counter {
      background-color: #d6eaf8;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 500;
    }
    .counter strong {
      color: #2980b9;
    }

    /* Filtros */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .filter-btn {
      padding: 10px 16px;
      border: none;
      background-color: #95a5a6;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .filter-btn:hover {
      opacity: 0.9;
    }
    .filter-btn.active {
      background-color: #2980b9;
      font-weight: bold;
    }

    /* Tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    thead {
      background-color: #2980b9;
      color: white;
    }
    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
    }
    tbody tr:hover {
      background-color: #f1f7fb;
    }
    .fecha {
      color: #2c3e50;
      font-weight: 500;
    }
    .empty {
      color: #bdc3c7;
      font-style: italic;
    }

    /* Tipo de planilla */
    .tipo {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }
    .tipo-cambio { background-color: #8e44ad; }
    .tipo-mejora { background-color: #27ae60; }
    .tipo-incidencia { background-color: #e67e22; }
    .tipo-otro { background-color: #3498db; }

    /* Panel desplegable */
    .collapsible {
      background-color: #2980b9;
      color: white;
      cursor: pointer;
      padding: 12px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 16px;
      border-radius: 8px;
      margin: 20px 0 10px 0;
    }
    .active, .collapsible:hover {
      background-color: #1a5276;
    }
    .content {
      display: none;
      overflow: hidden;
      margin-top: 10px;
    }
    .content.show {
      display: block;
    }

    /* Sin datos */
    .no-data {
      text-align: center;
      color: #777;
      padding: 20px;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      color: #777;
      font-size: 14px;
    }

    @media (max-width: 1024px) {
      .container {
        padding: 10px;
      }
      th, td {
        padding: 8px 6px;
        font-size: 14px;
      }
    }
    @media (max-width: 768px) {
      .filters, .counters {
        flex-direction: column;
        align-items: center;
      }
      .counter, .filter-btn {
        text-align: center;
      }
      table {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>📋 Dashboard de Planillas Knop</h1>
      <p>Seguimiento del ciclo: JP → JCC → ELL → Aseg. Calidad</p>
    </header>

    <div class="last-update">Última actualización: <span id="update-time">Cargando...</span></div>

    <!-- Contadores -->
    <div class="counters" id="counters">
      <div class="counter">Todas: <strong>0</strong></div>
      <div class="counter">Pendiente de JP: <strong>0</strong></div>
      <div class="counter">Pendiente de JCC: <strong>0</strong></div>
      <div class="counter">Pendiente de ELL: <strong>0</strong></div>
      <div class="counter">Pendiente de Aseg. Calidad: <strong>0</strong></div>
      <div class="counter">Cerradas: <strong>0</strong></div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <button class="filter-btn active" data-filter="todas">Todas</button>
      <button class="filter-btn" data-filter="jp">Pendiente de JP</button>
      <button class="filter-btn" data-filter="jcc">Pendiente de JCC</button>
      <button class="filter-btn" data-filter="ell">Pendiente de ELL</button>
      <button class="filter-btn" data-filter="aseg">Pendiente de Aseg. Calidad</button>
      <button class="filter-btn" data-filter="cerradas">Cerradas</button>
    </div>

    <!-- Tabla -->
    <table id="planillas-table">
      <thead>
        <tr>
          <th># Serie</th>
          <th>Nombre</th>
          <th>Fecha JP</th>
          <th>Fecha JCC</th>
          <th>Fecha ELL</th>
          <th>Fecha Aseg. Calidad</th>
          <th>Tipo Planilla</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="7" class="loading">Cargando datos...</td></tr>
      </tbody>
    </table>

    <!-- Panel de Cerradas (desplegable) -->
    <button class="collapsible" id="toggle-cerradas">✅ Planillas Cerradas (todas las firmas completas)</button>
    <div class="content" id="panel-cerradas">
      <table>
        <thead>
          <tr>
            <th># Serie</th>
            <th>Nombre</th>
            <th>Fecha JP</th>
            <th>Fecha JCC</th>
            <th>Fecha ELL</th>
            <th>Fecha Aseg. Calidad</th>
            <th>Tipo Planilla</th>
          </tr>
        </thead>
        <tbody id="table-cerradas"></tbody>
      </table>
    </div>

    <div class="footer">
      Dashboard interactivo | Actualización cada 30 segundos
    </div>
  </div>

  <script>
    // ✅ URL del CSV público
    const URL_CSV = "https://docs.google.com/spreadsheets/d/1bvHN5OPTjDlqJ4yG_MDIgAaJoqhp7rWcQRaYePStJXg/gviz/tq?tqx=out:csv&sheet=Hoja1";

    const tipoMap = {
      cambio: { clase: 'tipo-cambio', texto: 'Cambio' },
      mejora: { clase: 'tipo-mejora', texto: 'Mejora' },
      incidencia: { clase: 'tipo-incidencia', texto: 'Incidencia' },
      otro: { clase: 'tipo-otro', texto: 'Otro' }
    };

    function limpiarTexto(texto) {
      if (!texto || texto.trim() === "") return "";
      // Eliminar comillas dobles al inicio y fin
      return texto.replace(/^"|"$/g, '').trim();
    }

    function formatearFecha(fecha) {
      if (!fecha || fecha.trim() === "" || fecha === " ") return "<span class='empty'>—</span>";
      return `<span class='fecha'>${limpiarTexto(fecha)}</span>`;
    }

    function getTipoClase(tipo) {
      const t = (tipo || '').toLowerCase().trim();
      if (t.includes('cambio')) return tipoMap.cambio;
      if (t.includes('mejora')) return tipoMap.mejora;
      if (t.includes('incidencia') || t.includes('inci')) return tipoMap.incidencia;
      return tipoMap.otro;
    }

    let planillas = [];

    // Referencias a los contadores
    const counters = {
      todas: document.getElementById('counters').children[0].querySelector('strong'),
      jp: document.getElementById('counters').children[1].querySelector('strong'),
      jcc: document.getElementById('counters').children[2].querySelector('strong'),
      ell: document.getElementById('counters').children[3].querySelector('strong'),
      aseg: document.getElementById('counters').children[4].querySelector('strong'),
      cerradas: document.getElementById('counters').children[5].querySelector('strong')
    };

    async function cargarDatos() {
      try {
        const response = await fetch(URL_CSV + "&t=" + Date.now());
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const csv = await response.text();
        const lines = csv.trim().split('\n');
        
        if (lines.length < 2) {
          throw new Error("No hay datos");
        }

        const headers = lines[0]
          .split(',')
          .map(h => h.trim().replace(/^"(.*)"$/, '$1').toLowerCase());

        const col = {
          serie: headers.findIndex(h => h.includes('serie')),
          nombre: headers.findIndex(h => h.includes('nombre')),
          jp: headers.findIndex(h => h.includes('fecha jp') || h.includes('jp')),
          jcc: headers.findIndex(h => h.includes('jcc')),
          ell: headers.findIndex(h => h.includes('ell')),
          aseg: headers.findIndex(h => h.includes('aseg') && h.includes('calidad')),
          tipo: headers.findIndex(h => h.includes('tipo') && h.includes('planilla'))
        };

        planillas = lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim().replace(/^"(.*)"$/, '$1'));
          return {
            serie: col.serie >= 0 ? limpiarTexto(values[col.serie]) : '—',
            nombre: col.nombre >= 0 ? limpiarTexto(values[col.nombre]) : '—',
            jp: col.jp >= 0 ? limpiarTexto(values[col.jp]) : '',
            jcc: col.jcc >= 0 ? limpiarTexto(values[col.jcc]) : '',
            ell: col.ell >= 0 ? limpiarTexto(values[col.ell]) : '',
            aseg: col.aseg >= 0 ? limpiarTexto(values[col.aseg]) : '',
            tipo: col.tipo >= 0 ? limpiarTexto(values[col.tipo]) : ''
          };
        });

        // Calcular contadores
        const contadores = {
          todas: planillas.length,
          jp: planillas.filter(p => !p.jp).length,
          jcc: planillas.filter(p => p.jp && !p.jcc).length,
          ell: planillas.filter(p => p.jp && p.jcc && !p.ell).length,
          aseg: planillas.filter(p => p.jp && p.jcc && p.ell && !p.aseg).length,
          cerradas: planillas.filter(p => p.jp && p.jcc && p.ell && p.aseg).length
        };

        // Actualizar contadores en pantalla
        Object.keys(contadores).forEach(key => {
          counters[key].textContent = contadores[key];
        });

        // Aplicar filtro actual
        const filtroActivo = document.querySelector('.filter-btn.active').getAttribute('data-filter');
        aplicarFiltro(filtroActivo);
        llenarPanelCerradas();
        document.getElementById("update-time").textContent = new Date().toLocaleString('es-ES');

      } catch (error) {
        console.error("Error:", error);
        document.getElementById("table-body").innerHTML = 
          `<tr><td colspan="7" class="error">❌ Error: ${error.message}</td></tr>`;
        document.getElementById("update-time").textContent = "Error";
      }
    }

    function aplicarFiltro(filtro) {
      const tbody = document.getElementById("table-body");
      let filtradas = [];

      switch (filtro) {
        case 'todas':
          filtradas = planillas;
          break;
        case 'jp':
          filtradas = planillas.filter(p => !p.jp);
          break;
        case 'jcc':
          filtradas = planillas.filter(p => p.jp && !p.jcc);
          break;
        case 'ell':
          filtradas = planillas.filter(p => p.jp && p.jcc && !p.ell);
          break;
        case 'aseg':
          filtradas = planillas.filter(p => p.jp && p.jcc && p.ell && !p.aseg);
          break;
        case 'cerradas':
          filtradas = planillas.filter(p => p.jp && p.jcc && p.ell && p.aseg);
          break;
      }

      if (filtradas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data">No hay planillas en esta categoría</td></tr>`;
      } else {
        tbody.innerHTML = filtradas.map(p => {
          const tipoInfo = getTipoClase(p.tipo);
          return `
            <tr>
              <td><strong>${p.serie}</strong></td>
              <td>${p.nombre}</td>
              <td>${formatearFecha(p.jp)}</td>
              <td>${formatearFecha(p.jcc)}</td>
              <td>${formatearFecha(p.ell)}</td>
              <td>${formatearFecha(p.aseg)}</td>
              <td><span class="tipo ${tipoInfo.clase}">${tipoInfo.texto}</span></td>
            </tr>
          `;
        }).join('');
      }
    }

    function llenarPanelCerradas() {
      const tbody = document.getElementById("table-cerradas");
      const cerradas = planillas.filter(p => p.jp && p.jcc && p.ell && p.aseg);

      if (cerradas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data">No hay planillas cerradas</td></tr>`;
      } else {
        tbody.innerHTML = cerradas.map(p => {
          const tipoInfo = getTipoClase(p.tipo);
          return `
            <tr>
              <td><strong>${p.serie}</strong></td>
              <td>${p.nombre}</td>
              <td>${formatearFecha(p.jp)}</td>
              <td>${formatearFecha(p.jcc)}</td>
              <td>${formatearFecha(p.ell)}</td>
              <td>${formatearFecha(p.aseg)}</td>
              <td><span class="tipo ${tipoInfo.clase}">${tipoInfo.texto}</span></td>
            </tr>
          `;
        }).join('');
      }
    }

    // Eventos de filtros
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const filtro = btn.getAttribute('data-filter');
        aplicarFiltro(filtro);
      });
    });

    // Panel desplegable
    document.getElementById('toggle-cerradas').addEventListener('click', function() {
      this.classList.toggle('active');
      document.getElementById('panel-cerradas').classList.toggle('show');
    });

    // Cargar datos
    cargarDatos();
    setInterval(cargarDatos, 30000); // Cada 30 segundos
  </script>
</body>
</html>

